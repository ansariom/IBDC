queues = megraw,bpp,*@megraw2*
python_bin = /local/cluster/bin/python
prefix = tile
nfolds = 5
orig_coefs = $(prefix)/orig_coef_table.txt

all:
	software/extract_pwms_for_removal.R $(orig_coefs) $(prefix) 
	 n=220; while [[ $$n -le 440 ]]; do \
		echo $$n; \
		outdir=$(prefix)/top$$n; \
		mkdir $$outdir; \
		echo software/remove_features.R $(prefix)/all_features_diffs_wide.rdat $(prefix)/top$$n\_pwms.txt $$outdir  top$$n | \
			SGE_Array -q $(queues) -m 10G -r $$outdir/j1_rm_features_$$n ;\
		echo software/prepare_data_for_classification.R $$outdir/all_features_diffs_wide_top$$n\_removal.rdat tile_only $$outdir/tile_only_features_classed.csv $$outdir/tile_only_diff_info.csv |\
			SGE_Array -m 10G -q $(queues) -r $$outdir/j1_prepare_train_data_$$n --hold_names $$outdir/j1_rm_features_$$n;\
		echo $(python_bin) software/train_test_crossVal_noScale.py -i $$outdir/tile_only_features_classed.csv -o $$outdir -n $(nfolds) -t tile_only |\
			SGE_Array -q $(queues) -m 100G -r $$outdir/j1_crossval_train_test_$$n --hold_names $$outdir/j1_prepare_train_data_$$n; \
		((n = n + 20)); \
	done

perfromance_gathering:
	i=20; while [[ $$i -lt 490 ]]; do \
        	indir=$(prefix)/top$$i; \
                echo $$indir; \
                outfile=$(prefix)/performances_top$$i\.txt; \
                head $$indir/[1-9]*/*held* | grep -v "==" | grep -v "auroc" > $$outfile; \
		((i = i+20)); \
        done

plot:
	mkdir $(prefix)/perf_tables; \
	mv $(prefix)/performances_top* $(prefix)/perf_tables; \
	../software/plot_removal_performance.R $(prefix)/perf_tables/performances_top $(prefix)/perf_plot Tiled

